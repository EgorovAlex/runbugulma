<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ –æ—Ç–º–µ—Ç–∫–∏ –Ω–∞ –ö–ü</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
	<style>
		:root {
			--tg-theme-bg-color: #ffffff;
			--tg-theme-text-color: #222222;
			--tg-theme-button-color: #3498db;
			--tg-theme-button-text-color: #ffffff;
		}
		
		* {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
		}
		
		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			background: var(--tg-theme-bg-color);
			color: var(--tg-theme-text-color);
			margin: 0;
			padding: 12px;
			max-width: 100vw;
			overflow-x: hidden;
			-webkit-text-size-adjust: 100%;
		}
		
		.container {
			max-width: 100%;
			margin: 0 auto;
			padding: 0;
		}
		
		.header {
			text-align: center;
			margin-bottom: 16px;
			padding: 12px;
			background: linear-gradient(135deg, #3498db, #2980b9);
			color: white;
			border-radius: 12px;
			width: 100%;
		}
		
		.header h1 {
			font-size: 20px;
			margin-bottom: 5px;
		}
		
		.header p {
			font-size: 14px;
			margin: 0;
		}
		
		.status-bar {
			display: flex;
			justify-content: space-between;
			margin-bottom: 12px;
			font-size: 11px;
			color: #666;
			padding: 8px;
			background: #f8f9fa;
			border-radius: 8px;
			width: 100%;
		}
		
		.kp-info {
			background: #fff3cd;
			padding: 12px;
			border-radius: 10px;
			margin-bottom: 16px;
			border-left: 4px solid #ffc107;
			text-align: center;
			width: 100%;
		}
		
		.kp-info h3 {
			font-size: 16px;
			margin-bottom: 8px;
		}
		
		.input-section {
			margin-bottom: 16px;
			width: 100%;
			padding: 0 2px;
		}
		
		.number-input {
			width: 100%;
			max-width: 100%;
			padding: 14px;
			font-size: 18px;
			text-align: center;
			border: 2px solid #3498db;
			border-radius: 10px;
			margin-bottom: 10px;
			-webkit-appearance: none;
			-moz-appearance: textfield;
			background: white;
		}
		
		.number-input::-webkit-outer-spin-button,
		.number-input::-webkit-inner-spin-button {
			-webkit-appearance: none;
			margin: 0;
		}
		
		.button {
			background: var(--tg-theme-button-color);
			color: var(--tg-theme-button-text-color);
			border: none;
			padding: 14px;
			border-radius: 10px;
			font-size: 15px;
			font-weight: 500;
			cursor: pointer;
			width: 100%;
			margin: 4px 0;
		}
		
		.button-success {
			background: #2ecc71;
		}
		
		.button-danger {
			background: #e74c3c;
		}
		
		.button-secondary {
			background: transparent;
			color: var(--tg-theme-button-color);
			border: 2px solid var(--tg-theme-button-color);
			padding: 12px;
		}
		
		.participants-list {
			max-height: 250px;
			overflow-y: auto;
			margin-top: 16px;
			width: 100%;
		}
		
		.participant-item {
			background: #f8f9fa;
			padding: 10px;
			margin: 4px 0;
			border-radius: 8px;
			border-left: 4px solid #3498db;
			display: flex;
			justify-content: space-between;
			align-items: center;
			width: 100%;
		}
		
		.participant-time {
			font-size: 11px;
			color: #666;
		}
		
		.hidden {
			display: none;
		}
		
		.quick-buttons {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 4px;
			margin: 8px 0;
			width: 100%;
		}
		
		.quick-button {
			padding: 10px 4px;
			background: #ecf0f1;
			border: 1px solid #bdc3c7;
			border-radius: 6px;
			cursor: pointer;
			text-align: center;
			font-size: 15px;
			min-height: 40px;
			display: flex;
			align-items: center;
			justify-content: center;
		}
		
		.notification {
			position: fixed;
			top: 10px;
			left: 50%;
			transform: translateX(-50%);
			padding: 10px 16px;
			border-radius: 18px;
			z-index: 10000;
			font-size: 13px;
			box-shadow: 0 2px 8px rgba(0,0,0,0.2);
			color: white;
			max-width: 90%;
			text-align: center;
		}
		
		.notification.online {
			background: #4CAF50;
		}
		
		.notification.offline {
			background: #ff9800;
		}
		
		/* –£–±–∏—Ä–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É –Ω–∞ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–∞—Ö */
		* {
			max-width: 100%;
		}
		
		/* –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
		@media (max-width: 340px) {
			body {
				padding: 8px;
			}
			
			.header {
				padding: 10px;
				margin-bottom: 12px;
			}
			
			.header h1 {
				font-size: 18px;
			}
			
			.number-input {
				padding: 12px;
				font-size: 16px;
			}
			
			.button {
				padding: 12px;
				font-size: 14px;
			}
			
			.quick-button {
				padding: 8px 3px;
				font-size: 14px;
				min-height: 36px;
			}
			
			.status-bar {
				font-size: 10px;
				padding: 6px;
			}
		}
		
		/* –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —É–±–∏—Ä–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É */
		html, body {
			overflow-x: hidden !important;
			width: 100% !important;
			position: relative;
		}
		
		/* –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –≤–ª–µ–∑–∞—é—Ç */
		.container > * {
			max-width: 100%;
			box-sizing: border-box;
		}
	</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã –°–∏—Å—Ç–µ–º–∞ –æ—Ç–º–µ—Ç–∫–∏ –Ω–∞ –ö–ü</h1>
            <p>–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π –ø—É–Ω–∫—Ç: <span id="kpNumber">1</span></p>
        </div>
        
        <div class="status-bar">
            <span id="connectionStatus">üîå –û—Ñ—Ñ–ª–∞–π–Ω</span>
            <span id="participantsCount">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: 0</span>
            <span id="currentTime">--:--:--</span>
        </div>
        
        <div class="kp-info">
            <h3>–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π –ø—É–Ω–∫—Ç ‚Ññ<span id="currentKp">1</span></h3>
            <button class="button button-secondary" onclick="changeKp()">‚úèÔ∏è –°–º–µ–Ω–∏—Ç—å –ö–ü</button>
        </div>
        
        <div class="input-section">
            <input type="number" id="participantNumberInput" class="number-input" 
                   placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —É—á–∞—Å—Ç–Ω–∏–∫–∞" min="1" onkeypress="handleKeyPress(event)">
            
            <div class="quick-buttons">
                <div class="quick-button" onclick="addNumber('1')">1</div>
                <div class="quick-button" onclick="addNumber('2')">2</div>
                <div class="quick-button" onclick="addNumber('3')">3</div>
                <div class="quick-button" onclick="addNumber('4')">4</div>
                <div class="quick-button" onclick="addNumber('5')">5</div>
                <div class="quick-button" onclick="addNumber('6')">6</div>
                <div class="quick-button" onclick="addNumber('7')">7</div>
                <div class="quick-button" onclick="addNumber('8')">8</div>
                <div class="quick-button" onclick="addNumber('9')">9</div>
                <div class="quick-button" onclick="addNumber('0')">0</div>
                <div class="quick-button" onclick="clearInput()">‚å´</div>
                <div class="quick-button" onclick="submitNumber()">‚úÖ</div>
            </div>
            
            <button class="button button-success" onclick="submitNumber()">‚úÖ –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ</button>
        </div>
        
        <div>
            <h3>–û—Ç–º–µ—á–µ–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏:</h3>
            <div id="participantsList" class="participants-list"></div>
        </div>
        
        <div>
            <button class="button" onclick="exportToGoogleSheets()">üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ Google –¢–∞–±–ª–∏—Ü—ã</button>
            <button class="button button-danger" onclick="clearAllData()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        </div>
    </div>

    <script>
        // ===== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø =====
        // –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® URL Google Apps Script –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/–í–ê–®_ID_–°–ö–†–ò–ü–¢–ê/exec';
        
        let tg = window.Telegram.WebApp;
        let eventData = {
            kpNumber: 1,
            participants: [],
            lastExport: null
        };
        
        // ===== SERVICE WORKER =====
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º Service Worker –∏–∑ —Ç–æ–≥–æ –∂–µ –∫–∞—Ç–∞–ª–æ–≥–∞
                    const registration = await navigator.serviceWorker.register('sw.js');
                    console.log('Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
                    return registration;
                } catch (error) {
                    console.warn('Service Worker –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', error);
                    return null;
                }
            }
            return null;
        }
        
        // ===== –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò =====
        function showNotification(message, type = 'online') {
            // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            const oldNotifications = document.querySelectorAll('.notification');
            oldNotifications.forEach(note => note.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 3000);
        }
        
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            const isOnline = navigator.onLine;
            
            statusElement.textContent = isOnline ? 'üåê –û–Ω–ª–∞–π–Ω' : 'üîå –û—Ñ—Ñ–ª–∞–π–Ω';
            statusElement.style.color = isOnline ? '#2ecc71' : '#e74c3c';
            
            if (!isOnline) {
                showNotification('–†–∞–±–æ—Ç–∞–µ–º –≤ –æ—Ñ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º–µ', 'offline');
            }
        }
        
        function updateCurrentTime() {
            document.getElementById('currentTime').textContent = 
                new Date().toLocaleTimeString('ru-RU');
        }
        
        function updateParticipantsCount() {
            const kpParticipants = eventData.participants.filter(p => p.kp === eventData.kpNumber);
            document.getElementById('participantsCount').textContent = 
                `–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${kpParticipants.length}`;
        }
        
        function updateKpInfo() {
            document.getElementById('kpNumber').textContent = eventData.kpNumber;
            document.getElementById('currentKp').textContent = eventData.kpNumber;
        }
        
        function loadData() {
            const saved = localStorage.getItem('kp_tracking_data');
            if (saved) {
                try {
                    eventData = JSON.parse(saved);
                    updateKpInfo();
                    updateParticipantsCount();
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', e);
                }
            }
        }
        
        function saveData() {
            localStorage.setItem('kp_tracking_data', JSON.stringify(eventData));
            updateParticipantsCount();
        }
        
        // ===== –£–ü–†–ê–í–õ–ï–ù–ò–ï –í–í–û–î–û–ú =====
        function addNumber(num) {
            const input = document.getElementById('participantNumberInput');
            input.value += num;
        }
        
        function clearInput() {
            document.getElementById('participantNumberInput').value = '';
        }
        
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                submitNumber();
                event.preventDefault();
            }
        }
        
        function changeKp() {
            const newKp = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–∞:', eventData.kpNumber);
            if (newKp && !isNaN(newKp)) {
                eventData.kpNumber = parseInt(newKp);
                saveData();
                updateKpInfo();
                renderParticipants();
            }
        }
        
        function submitNumber() {
            const input = document.getElementById('participantNumberInput');
            const number = input.value.trim();
            
            if (!number) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —É—á–∞—Å—Ç–Ω–∏–∫–∞', 'offline');
                return;
            }
            
            if (eventData.participants.some(p => p.number === number && p.kp === eventData.kpNumber)) {
                if (!confirm('–≠—Ç–æ—Ç —É—á–∞—Å—Ç–Ω–∏–∫ —É–∂–µ –æ—Ç–º–µ—á–µ–Ω –Ω–∞ —ç—Ç–æ–º –ö–ü. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ?')) {
                    return;
                }
            }
            
            const participant = {
                number: number,
                kp: eventData.kpNumber,
                timestamp: new Date().toISOString(),
                time: new Date().toLocaleTimeString('ru-RU'),
                date: new Date().toLocaleDateString('ru-RU')
            };
            
            eventData.participants.push(participant);
            saveData();
            renderParticipants();
            
            input.value = '';
            input.focus();
            
            showNotification(`–£—á–∞—Å—Ç–Ω–∏–∫ ‚Ññ${number} –æ—Ç–º–µ—á–µ–Ω –Ω–∞ –ö–ü${eventData.kpNumber}`);
        }
        
        function renderParticipants() {
            const container = document.getElementById('participantsList');
            container.innerHTML = '';
            
            const kpParticipants = eventData.participants.filter(p => p.kp === eventData.kpNumber);
            
            if (kpParticipants.length === 0) {
                container.innerHTML = '<p>–ù–µ—Ç –æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>';
                return;
            }
            
            kpParticipants.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            kpParticipants.forEach(participant => {
                const item = document.createElement('div');
                item.className = 'participant-item';
                item.innerHTML = `
                    <div>
                        <strong>‚Ññ${participant.number}</strong>
                        <div class="participant-time">${participant.time}</div>
                    </div>
                    <button onclick="removeParticipant('${participant.timestamp}')" 
                            style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">
                        ‚ùå
                    </button>
                `;
                container.appendChild(item);
            });
        }
        
        function removeParticipant(timestamp) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –æ—Ç–º–µ—Ç–∫—É?')) {
                eventData.participants = eventData.participants.filter(p => p.timestamp !== timestamp);
                saveData();
                renderParticipants();
            }
        }
        
        // ===== –≠–ö–°–ü–û–†–¢ –î–ê–ù–ù–´–• =====
        async function exportToGoogleSheets() {
            if (eventData.participants.length === 0) {
                showNotification('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'offline');
                return;
            }
            
            if (!navigator.onLine) {
                showNotification('–¢—Ä–µ–±—É–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'offline');
                return;
            }
            
            try {
                const kpParticipants = eventData.participants.filter(p => p.kp === eventData.kpNumber);
                const exportData = {
                    kpNumber: eventData.kpNumber,
                    participants: kpParticipants,
                    exportTime: new Date().toISOString()
                };
                
                // –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ Google Apps Script
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(exportData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification(`–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã! –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ: ${result.processed} –∑–∞–ø–∏—Å–µ–π`);
                    
                    // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
                    eventData.lastExport = new Date().toISOString();
                    saveData();
                } else {
                    throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞. –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ CSV', 'offline');
                
                // –†–µ–∑–µ—Ä–≤–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ CSV
                let csv = '–ù–æ–º–µ—Ä —É—á–∞—Å—Ç–Ω–∏–∫–∞,–ö–ü,–î–∞—Ç–∞,–í—Ä–µ–º—è,Timestamp\n';
                eventData.participants.forEach(p => {
                    csv += `"${p.number}","–ö–ü${p.kp}","${p.date}","${p.time}","${p.timestamp}"\n`;
                });
                
                downloadCSV(csv, `kp${eventData.kpNumber}_—Ä–µ–∑–µ—Ä–≤_${new Date().toISOString().split('T')[0]}.csv`);
            }
        }
        
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
        }
        
        function clearAllData() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—Å–µ–º –ö–ü? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                if (confirm('–¢–æ—á–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!')) {
                    eventData.participants = [];
                    localStorage.removeItem('kp_tracking_data');
                    renderParticipants();
                    updateParticipantsCount();
                    showNotification('–í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã');
                }
            }
        }
        
        // ===== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø =====
        async function init() {
            // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º Service Worker –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
            await registerServiceWorker();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            loadData();
            updateConnectionStatus();
            updateCurrentTime();
            renderParticipants();
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Telegram Web App
            tg.expand();
            tg.enableClosingConfirmation();
            tg.ready();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –∏ —Å—Ç–∞—Ç—É—Å
            setInterval(updateCurrentTime, 1000);
            setInterval(updateConnectionStatus, 5000);
            
            // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å–∞
            window.addEventListener('online', updateConnectionStatus);
            window.addEventListener('offline', updateConnectionStatus);
            
            // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            document.getElementById('participantNumberInput').focus();
            
            console.log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ. –†–µ–∂–∏–º:', navigator.onLine ? '–æ–Ω–ª–∞–π–Ω' : '–æ—Ñ—Ñ–ª–∞–π–Ω');
        }
        
        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>