<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°–∏—Å—Ç–µ–º–∞ –æ—Ç–º–µ—Ç–∫–∏ –Ω–∞ –ö–ü</title>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —Å—Ç–∏–ª–∏ -->
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="images/icon-192.png">
    <link rel="apple-touch-icon" href="images/icon-192.png">
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <div class="container">
        <div id="offlineIndicator">üîå –û—Ñ—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º</div>
        <div id="platformIndicator">Platform: <span id="platformType">Detecting...</span></div>
        
        <div class="header">
            <h1>üìã –°–∏—Å—Ç–µ–º–∞ –æ—Ç–º–µ—Ç–∫–∏ –Ω–∞ –ö–ü</h1>
            <p id="eventName">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>
        </div>
        
        <div class="status-bar">
            <span id="connectionStatus" class="status-item">üîå –û—Ñ—Ñ–ª–∞–π–Ω</span>
            <span id="participantsCount" class="status-item">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: 0</span>
            <span id="currentTime" class="status-item">--:--:--</span>
        </div>
        
        <div id="loadingSection">
            <div class="kp-info">
                <p>üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è...</p>
            </div>
        </div>
        
        <div id="mainSection" class="hidden">
            <div class="kp-info">
                <h3>–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π –ø—É–Ω–∫—Ç ‚Ññ<span id="currentKp">1</span></h3>
                <p><span id="kpName">–ù–∞–∑–≤–∞–Ω–∏–µ –ö–ü</span></p>
                <button class="button button-secondary" onclick="changeKp()">‚úèÔ∏è –°–º–µ–Ω–∏—Ç—å –ö–ü</button>
            </div>
            
            <div class="stats-card">
                <h4>üìä –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –ö–ü</h4>
                <div class="progress-bar">
                    <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                </div>
                <p>–û—Ç–º–µ—á–µ–Ω–æ: <span id="passedCount">0</span> / <span id="totalCount">0</span></p>
                <p id="completionPercent">0%</p>
            </div>
            
            <div class="input-section">
                <input type="number" id="participantNumberInput" class="number-input" 
                       placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —É—á–∞—Å—Ç–Ω–∏–∫–∞" min="1" onkeypress="handleKeyPress(event)">
                
                <div class="quick-buttons">
                    <div class="quick-button" onclick="addNumber('1')">1</div>
                    <div class="quick-button" onclick="addNumber('2')">2</div>
                    <div class="quick-button" onclick="addNumber('3')">3</div>
                    <div class="quick-button" onclick="addNumber('4')">4</div>
                    <div class="quick-button" onclick="addNumber('5')">5</div>
                    <div class="quick-button" onclick="addNumber('6')">6</div>
                    <div class="quick-button" onclick="addNumber('7')">7</div>
                    <div class="quick-button" onclick="addNumber('8')">8</div>
                    <div class="quick-button" onclick="addNumber('9')">9</div>
                    <div class="quick-button" onclick="addNumber('0')">0</div>
                    <div class="quick-button" onclick="clearInput()">‚å´</div>
                    <div class="quick-button" onclick="submitNumber()">‚úÖ</div>
                </div>
                
                <button class="button button-success" onclick="submitNumber()">‚úÖ –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ</button>
            </div>
            
            <div>
                <h3>üìù –û—Ç–º–µ—á–µ–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏:</h3>
                <div id="participantsList" class="participants-list"></div>
            </div>
            
            <div>
                <button class="button button-warning" onclick="syncWithBot()">üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="button button-danger" onclick="clearAllData()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
            </div>
        </div>
    </div>

    <script>
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/–í–ê–®_GAS_ID/exec';
        let tg = window.Telegram.WebApp;
        let eventData = {
            kpNumber: 1,
            participants: [],
            eventInfo: null,
            kpStats: {},
            lastSync: null
        };
        
        let isSyncing = false;
        let syncQueue = [];
        let currentChatId = null;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        async function init() {
            tg.expand();
            tg.enableClosingConfirmation();
            tg.ready();
            
            currentChatId = tg.initDataUnsafe.user?.id || tg.initDataUnsafe.chat?.id;
            
            detectPlatform();
            loadData();
            updateConnectionStatus();
            updateCurrentTime();
            
            setInterval(updateCurrentTime, 1000);
            setInterval(updateConnectionStatus, 5000);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
            await loadEventData();
            
            document.getElementById('participantNumberInput').focus();
            
            // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º Service Worker
            await registerServiceWorker();
        }
        
        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js', {
                        scope: '/',
                        updateViaCache: 'none'
                    });
                    
                    console.log('Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: ', registration);
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Service Worker: ', error);
                }
            }
        }
        
        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
        function detectPlatform() {
            const isDesktop = window.innerWidth >= 768;
            const platformType = document.getElementById('platformType');
            
            if (platformType) {
                platformType.textContent = isDesktop ? 'Desktop' : 'Mobile';
            }
            
            if (isDesktop) {
                document.body.classList.add('desktop-mode');
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è
        async function loadEventData() {
            try {
                showLoading(true);
                
                // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ —Å–µ—Ç–∏
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'get_event_data' })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                eventData.eventInfo = data;
                updateEventUI();
                showLoading(false);
                
                // –ö—ç—à–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
                localStorage.setItem('cached_event_data', JSON.stringify(data));
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è:', error);
                
                // –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                const cachedData = localStorage.getItem('cached_event_data');
                if (cachedData) {
                    try {
                        eventData.eventInfo = JSON.parse(cachedData);
                        updateEventUI();
                        showLoading(false);
                        showMessage('‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
                    } catch (parseError) {
                        showMessage('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è');
                        showLoading(false);
                    }
                } else {
                    showMessage('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è');
                    showLoading(false);
                }
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —Å–æ–±—ã—Ç–∏—è
        function updateEventUI() {
            if (!eventData.eventInfo) return;
            
            const kp = eventData.eventInfo.kpList.find(k => k.number == eventData.kpNumber) || 
                      eventData.eventInfo.kpList[0];
            
            if (kp) {
                document.getElementById('currentKp').textContent = kp.number;
                document.getElementById('kpName').textContent = kp.name;
                document.getElementById('totalCount').textContent = kp.totalParticipants;
                
                const stats = eventData.eventInfo.participants[kp.number] || { passed: 0 };
                document.getElementById('passedCount').textContent = stats.passed;
                
                const percent = kp.totalParticipants > 0 ? 
                    Math.round((stats.passed / kp.totalParticipants) * 100) : 0;
                document.getElementById('progressFill').style.width = percent + '%';
                document.getElementById('completionPercent').textContent = percent + '%';
            }
            
            if (eventData.eventInfo.eventName) {
                document.getElementById('eventName').textContent = eventData.eventInfo.eventName;
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        function loadData() {
            const saved = localStorage.getItem('kp_tracking_data');
            if (saved) {
                try {
                    eventData = JSON.parse(saved);
                    updateKpInfo();
                    updateParticipantsCount();
                    renderParticipants();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', error);
                }
            }
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        function saveData() {
            try {
                localStorage.setItem('kp_tracking_data', JSON.stringify(eventData));
                updateParticipantsCount();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
            }
        }
        
        // –°–º–µ–Ω–∞ –ö–ü
        function changeKp() {
            if (!eventData.eventInfo) return;
            
            const newKp = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–∞:', eventData.kpNumber);
            if (newKp && !isNaN(newKp)) {
                eventData.kpNumber = parseInt(newKp);
                saveData();
                updateKpInfo();
                updateEventUI();
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ö–ü
        function updateKpInfo() {
            document.getElementById('currentKp').textContent = eventData.kpNumber;
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ü–∏—Ñ—Ä—ã –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        function addNumber(num) {
            const input = document.getElementById('participantNumberInput');
            input.value += num;
        }
        
        // –û—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è –≤–≤–æ–¥–∞
        function clearInput() {
            document.getElementById('participantNumberInput').value = '';
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è Enter
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                submitNumber();
                event.preventDefault();
            }
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–º–µ—Ä–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞
        function submitNumber() {
            const input = document.getElementById('participantNumberInput');
            const number = input.value.trim();
            
            if (!number) {
                showMessage('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —É—á–∞—Å—Ç–Ω–∏–∫–∞');
                return;
            }
            
            if (eventData.participants.some(p => p.number === number && p.kp === eventData.kpNumber)) {
                if (!confirm('–≠—Ç–æ—Ç —É—á–∞—Å—Ç–Ω–∏–∫ —É–∂–µ –æ—Ç–º–µ—á–µ–Ω –Ω–∞ —ç—Ç–æ–º –ö–ü. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ?')) {
                    return;
                }
            }
            
            const participant = {
                number: number,
                kp: eventData.kpNumber,
                timestamp: new Date().toISOString(),
                time: new Date().toLocaleTimeString('ru-RU'),
                date: new Date().toLocaleDateString('ru-RU')
            };
            
            eventData.participants.push(participant);
            saveData();
            renderParticipants();
            
            input.value = '';
            input.focus();
            
            showMessage(`–£—á–∞—Å—Ç–Ω–∏–∫ ‚Ññ${number} –æ—Ç–º–µ—á–µ–Ω –Ω–∞ –ö–ü${eventData.kpNumber}`);
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        function renderParticipants() {
            const container = document.getElementById('participantsList');
            container.innerHTML = '';
            
            const kpParticipants = eventData.participants.filter(p => p.kp === eventData.kpNumber);
            
            if (kpParticipants.length === 0) {
                container.innerHTML = '<p>–ù–µ—Ç –æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>';
                return;
            }
            
            kpParticipants.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            kpParticipants.forEach(participant => {
                const item = document.createElement('div');
                item.className = 'participant-item';
                item.innerHTML = `
                    <div>
                        <strong>‚Ññ${participant.number}</strong>
                        <div class="participant-time">${participant.time}</div>
                    </div>
                    <button onclick="removeParticipant('${participant.timestamp}')" 
                            style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">
                        ‚ùå
                    </button>
                `;
                container.appendChild(item);
            });
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞
        function removeParticipant(timestamp) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –æ—Ç–º–µ—Ç–∫—É?')) {
                eventData.participants = eventData.participants.filter(p => p.timestamp !== timestamp);
                saveData();
                renderParticipants();
            }
        }
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –±–æ—Ç–æ–º
        async function syncWithBot() {
            if (isSyncing) {
                showMessage('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...');
                return;
            }
            
            if (eventData.participants.length === 0) {
                showMessage('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏');
                return;
            }
            
            if (!navigator.onLine) {
                showMessage('–¢—Ä–µ–±—É–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏');
                return;
            }
            
            isSyncing = true;
            showMessage('üîÑ –ù–∞—á–∏–Ω–∞—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é...');
            
            syncQueue = [...eventData.participants];
            await processSyncQueue();
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        async function processSyncQueue() {
            let successCount = 0;
            let errorCount = 0;
            
            while (syncQueue.length > 0) {
                const participant = syncQueue[0];
                
                try {
                    const success = await sendToBotSafe(participant);
                    
                    if (success) {
                        eventData.participants = eventData.participants.filter(p => 
                            p.timestamp !== participant.timestamp
                        );
                        syncQueue.shift();
                        successCount++;
                        
                        saveData();
                        renderParticipants();
                        updateParticipantsCount();
                        
                        showMessage(`‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: ${successCount} | –û—Å—Ç–∞–ª–æ—Å—å: ${syncQueue.length}`);
                    } else {
                        errorCount++;
                        showMessage('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏. –ü—Ä–µ—Ä—ã–≤–∞—é...');
                        break;
                    }
                    
                    // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', error);
                    errorCount++;
                    showMessage('‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏');
                    break;
                }
            }
            
            isSyncing = false;
            
            if (successCount > 0) {
                showMessage(`üéâ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –£—Å–ø–µ—à–Ω–æ: ${successCount}, –æ—à–∏–±–æ–∫: ${errorCount}`);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                setTimeout(() => loadEventData(), 1000);
            }
        }
        
        // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –±–æ—Ç—É
        async function sendToBotSafe(participant) {
            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'sync_runner',
                        kpNumber: participant.kp,
                        runnerNumber: participant.number,
                        timestamp: participant.timestamp,
                        time: participant.time,
                        chatId: currentChatId
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return data.success;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –±–æ—Ç—É:', error);
                return false;
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            const offlineIndicator = document.getElementById('offlineIndicator');
            const wasOffline = statusElement.textContent.includes('–û—Ñ—Ñ–ª–∞–π–Ω');
            const isNowOnline = navigator.onLine;
            
            statusElement.textContent = navigator.onLine ? 'üåê –û–Ω–ª–∞–π–Ω' : 'üîå –û—Ñ—Ñ–ª–∞–π–Ω';
            statusElement.style.color = navigator.onLine ? '#2ecc71' : '#e74c3c';
            
            if (offlineIndicator) {
                offlineIndicator.style.display = navigator.onLine ? 'none' : 'block';
            }
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
            if (wasOffline && isNowOnline && eventData.participants.length > 0 && !isSyncing) {
                setTimeout(() => {
                    if (confirm('–ò–Ω—Ç–µ—Ä–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω! –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ?')) {
                        syncWithBot();
                    }
                }, 2000);
            }
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
        function updateCurrentTime() {
            document.getElementById('currentTime').textContent = 
                new Date().toLocaleTimeString('ru-RU');
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        function updateParticipantsCount() {
            const kpParticipants = eventData.participants.filter(p => p.kp === eventData.kpNumber);
            document.getElementById('participantsCount').textContent = 
                `–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${kpParticipants.length}`;
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
        function showLoading(show) {
            document.getElementById('loadingSection').classList.toggle('hidden', !show);
            document.getElementById('mainSection').classList.toggle('hidden', show);
            document.body.classList.toggle('loading', show);
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function showMessage(message) {
            // –ú–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å toast-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            console.log(message);
            alert(message); // –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ
        }
        
        // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
        function clearAllData() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—Å–µ–º –ö–ü? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                if (confirm('–¢–æ—á–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!')) {
                    eventData.participants = [];
                    localStorage.removeItem('kp_tracking_data');
                    renderParticipants();
                    updateParticipantsCount();
                    showMessage('–í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã');
                }
            }
        }
        
        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', init);
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        window.addEventListener('resize', detectPlatform);
        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);
    </script>
</body>
</html>