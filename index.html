<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°–∏—Å—Ç–µ–º–∞ –æ—Ç–º–µ—Ç–∫–∏ –Ω–∞ –ö–ü</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
	<style>
		:root {
			--tg-theme-bg-color: #ffffff;
			--tg-theme-text-color: #222222;
			--tg-theme-button-color: #3498db;
			--tg-theme-button-text-color: #ffffff;
		}
		
		* {
			box-sizing: border-box; /* –í–∞–∂–Ω–æ! */
			margin: 0;
			padding: 0;
		}
		
		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			background: var(--tg-theme-bg-color);
			color: var(--tg-theme-text-color);
			margin: 0;
			padding: 16px;
			max-width: 100vw; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —à–∏—Ä–∏–Ω—É */
			overflow-x: hidden; /* –°–∫—Ä—ã–≤–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É */
		}
		
		.container {
			max-width: 100%;
			margin: 0 auto;
		}
		
		.header {
			text-align: center;
			margin-bottom: 20px;
			padding: 15px;
			background: linear-gradient(135deg, #3498db, #2980b9);
			color: white;
			border-radius: 15px;
			width: 100%;
		}
		
		.status-bar {
			display: flex;
			justify-content: space-between;
			margin-bottom: 15px;
			font-size: 12px;
			color: #666;
			padding: 8px;
			background: #f8f9fa;
			border-radius: 8px;
			width: 100%;
		}
		
		.kp-info {
			background: #fff3cd;
			padding: 12px;
			border-radius: 10px;
			margin-bottom: 15px;
			border-left: 4px solid #ffc107;
			text-align: center;
			width: 100%;
		}
		
		.input-section {
			margin-bottom: 20px;
			width: 100%;
			padding: 0 5px; /* –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à–∏–µ –æ—Ç—Å—Ç—É–ø—ã –ø–æ –±–æ–∫–∞–º */
		}
		
		.number-input {
			width: 100%;
			max-width: 100%; /* –í–∞–∂–Ω–æ! */
			padding: 15px;
			font-size: 20px; /* –ù–µ–º–Ω–æ–≥–æ —É–º–µ–Ω—å—à–∞–µ–º —à—Ä–∏—Ñ—Ç */
			text-align: center;
			border: 2px solid #3498db;
			border-radius: 10px;
			margin-bottom: 10px;
			-webkit-appearance: none; /* –£–±–∏—Ä–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏ iOS */
			-moz-appearance: textfield; /* –£–±–∏—Ä–∞–µ–º —Å—Ç—Ä–µ–ª–∫–∏ –≤ Firefox */
		}
		
		/* –£–±–∏—Ä–∞–µ–º —Å—Ç—Ä–µ–ª–∫–∏ —É number input */
		.number-input::-webkit-outer-spin-button,
		.number-input::-webkit-inner-spin-button {
			-webkit-appearance: none;
			margin: 0;
		}
		
		.button {
			background: var(--tg-theme-button-color);
			color: var(--tg-theme-button-text-color);
			border: none;
			padding: 15px;
			border-radius: 10px;
			font-size: 16px;
			font-weight: 500;
			cursor: pointer;
			width: 100%;
			margin: 5px 0;
		}
		
		.button-success {
			background: #2ecc71;
		}
		
		.button-danger {
			background: #e74c3c;
		}
		
		.button-secondary {
			background: transparent;
			color: var(--tg-theme-button-color);
			border: 2px solid var(--tg-theme-button-color);
		}
		
		.participants-list {
			max-height: 300px;
			overflow-y: auto;
			margin-top: 20px;
			width: 100%;
		}
		
		.participant-item {
			background: #f8f9fa;
			padding: 10px;
			margin: 5px 0;
			border-radius: 8px;
			border-left: 4px solid #3498db;
			display: flex;
			justify-content: space-between;
			align-items: center;
			width: 100%;
		}
		
		.participant-time {
			font-size: 12px;
			color: #666;
		}
		
		.hidden {
			display: none;
		}
		
		.quick-buttons {
			display: grid;
			grid-template-columns: repeat(3, 1fr);
			gap: 5px;
			margin: 10px 0;
			width: 100%;
		}
		
		.quick-button {
			padding: 12px 5px; /* –£–º–µ–Ω—å—à–∞–µ–º padding –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
			background: #ecf0f1;
			border: 1px solid #bdc3c7;
			border-radius: 5px;
			cursor: pointer;
			text-align: center;
			font-size: 16px;
			min-height: 44px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è touch */
			display: flex;
			align-items: center;
			justify-content: center;
		}
		
		/* –ú–µ–¥–∏–∞-–∑–∞–ø—Ä–æ—Å –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
		@media (max-width: 320px) {
			.number-input {
				font-size: 18px;
				padding: 12px;
			}
			
			.quick-button {
				padding: 10px 3px;
				font-size: 14px;
			}
			
			body {
				padding: 12px;
			}
		}
	</style>
</head>
<body>
    <div class="header">
        <h1>üìã –°–∏—Å—Ç–µ–º–∞ –æ—Ç–º–µ—Ç–∫–∏ –Ω–∞ –ö–ü</h1>
        <p>–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π –ø—É–Ω–∫—Ç: <span id="kpNumber">1</span></p>
    </div>
    
    <div class="status-bar">
        <span id="connectionStatus">üîå –û—Ñ—Ñ–ª–∞–π–Ω</span>
        <span id="participantsCount">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: 0</span>
        <span id="currentTime">--:--:--</span>
    </div>
    
    <div class="kp-info">
        <h3>–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π –ø—É–Ω–∫—Ç ‚Ññ<span id="currentKp">1</span></h3>
        <button class="button button-secondary" onclick="changeKp()">‚úèÔ∏è –°–º–µ–Ω–∏—Ç—å –ö–ü</button>
    </div>
    
    <div class="input-section">
        <input type="number" id="participantNumberInput" class="number-input" 
               placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —É—á–∞—Å—Ç–Ω–∏–∫–∞" min="1" onkeypress="handleKeyPress(event)">
        
        <div class="quick-buttons">
            <div class="quick-button" onclick="addNumber('1')">1</div>
            <div class="quick-button" onclick="addNumber('2')">2</div>
            <div class="quick-button" onclick="addNumber('3')">3</div>
            <div class="quick-button" onclick="addNumber('4')">4</div>
            <div class="quick-button" onclick="addNumber('5')">5</div>
            <div class="quick-button" onclick="addNumber('6')">6</div>
            <div class="quick-button" onclick="addNumber('7')">7</div>
            <div class="quick-button" onclick="addNumber('8')">8</div>
            <div class="quick-button" onclick="addNumber('9')">9</div>
            <div class="quick-button" onclick="addNumber('0')">0</div>
            <div class="quick-button" onclick="clearInput()">‚å´</div>
            <div class="quick-button" onclick="submitNumber()">‚úÖ</div>
        </div>
        
        <button class="button button-success" onclick="submitNumber()">‚úÖ –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ</button>
    </div>
    
    <div>
        <h3>–û—Ç–º–µ—á–µ–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏:</h3>
        <div id="participantsList" class="participants-list"></div>
    </div>
    
    <div>
        <button class="button" onclick="exportToGoogleSheets()">üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ Google –¢–∞–±–ª–∏—Ü—ã</button>
        <button class="button button-danger" onclick="clearAllData()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        let eventData = {
            kpNumber: 1,
            participants: [],
            lastExport: null
        };
        
        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    console.log('Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:', registration);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
                    if (registration.installing) {
                        console.log('Service Worker —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è');
                    } else if (registration.waiting) {
                        console.log('Service Worker –æ–∂–∏–¥–∞–µ—Ç');
                    } else if (registration.active) {
                        console.log('Service Worker –∞–∫—Ç–∏–≤–µ–Ω');
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ Service Worker:', error);
                }
            }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        function checkCachedState() {
            if (!navigator.onLine) {
                console.log('–†–∞–±–æ—Ç–∞–µ–º –≤ –æ—Ñ—Ñ–ª–∞–π–Ω-—Ä–µ–∂–∏–º–µ');
                updateConnectionStatus();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ñ—Ñ–ª–∞–π–Ω-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                showOfflineNotification();
            }
        }
        
        function showOfflineNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                background: #ff9800;
                color: white;
                padding: 10px 20px;
                border-radius: 20px;
                z-index: 10000;
                font-size: 14px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            `;
            notification.textContent = 'üîå –†–∞–±–æ—Ç–∞–µ–º –æ—Ñ—Ñ–ª–∞–π–Ω';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function init() {
            // –°–Ω–∞—á–∞–ª–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º Service Worker
            await registerServiceWorker();
            
            loadData();
            updateConnectionStatus();
            updateCurrentTime();
            renderParticipants();
            checkCachedState();
            
            tg.expand();
            tg.enableClosingConfirmation();
            
            setInterval(updateCurrentTime, 1000);
            setInterval(updateConnectionStatus, 5000);
            
            // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å–∞
            window.addEventListener('online', () => {
                updateConnectionStatus();
                showOnlineNotification();
            });
            
            window.addEventListener('offline', () => {
                updateConnectionStatus();
                showOfflineNotification();
            });
            
            // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            document.getElementById('participantNumberInput').focus();
        }
        
        function showOnlineNotification() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                background: #4CAF50;
                color: white;
                padding: 10px 20px;
                border-radius: 20px;
                z-index: 10000;
                font-size: 14px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            `;
            notification.textContent = 'üåê –û–Ω–ª–∞–π–Ω —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
                
        function loadData() {
            const saved = localStorage.getItem('kp_tracking_data');
            if (saved) {
                eventData = JSON.parse(saved);
                updateKpInfo();
                updateParticipantsCount();
            }
        }
        
        function saveData() {
            localStorage.setItem('kp_tracking_data', JSON.stringify(eventData));
            updateParticipantsCount();
        }
        
        function changeKp() {
            const newKp = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–∞:', eventData.kpNumber);
            if (newKp && !isNaN(newKp)) {
                eventData.kpNumber = parseInt(newKp);
                saveData();
                updateKpInfo();
            }
        }
        
        function updateKpInfo() {
            document.getElementById('kpNumber').textContent = eventData.kpNumber;
            document.getElementById('currentKp').textContent = eventData.kpNumber;
        }
        
        function addNumber(num) {
            const input = document.getElementById('participantNumberInput');
            input.value += num;
        }
        
        function clearInput() {
            document.getElementById('participantNumberInput').value = '';
        }
        
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                submitNumber();
                event.preventDefault();
            }
        }
        
        function submitNumber() {
            const input = document.getElementById('participantNumberInput');
            const number = input.value.trim();
            
            if (!number) {
                showMessage('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —É—á–∞—Å—Ç–Ω–∏–∫–∞');
                return;
            }
            
            if (eventData.participants.some(p => p.number === number && p.kp === eventData.kpNumber)) {
                if (!confirm('–≠—Ç–æ—Ç —É—á–∞—Å—Ç–Ω–∏–∫ —É–∂–µ –æ—Ç–º–µ—á–µ–Ω –Ω–∞ —ç—Ç–æ–º –ö–ü. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ?')) {
                    return;
                }
            }
            
            const participant = {
                number: number,
                kp: eventData.kpNumber,
                timestamp: new Date().toISOString(),
                time: new Date().toLocaleTimeString('ru-RU'),
                date: new Date().toLocaleDateString('ru-RU')
            };
            
            eventData.participants.push(participant);
            saveData();
            renderParticipants();
            
            input.value = '';
            input.focus();
            
            showMessage(`–£—á–∞—Å—Ç–Ω–∏–∫ ‚Ññ${number} –æ—Ç–º–µ—á–µ–Ω –Ω–∞ –ö–ü${eventData.kpNumber}`);
        }
        
        function renderParticipants() {
            const container = document.getElementById('participantsList');
            container.innerHTML = '';
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø–æ —Ç–µ–∫—É—â–µ–º—É –ö–ü
            const kpParticipants = eventData.participants.filter(p => p.kp === eventData.kpNumber);
            
            if (kpParticipants.length === 0) {
                container.innerHTML = '<p>–ù–µ—Ç –æ—Ç–º–µ—á–µ–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>';
                return;
            }
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
            kpParticipants.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            kpParticipants.forEach(participant => {
                const item = document.createElement('div');
                item.className = 'participant-item';
                item.innerHTML = `
                    <div>
                        <strong>‚Ññ${participant.number}</strong>
                        <div class="participant-time">${participant.time}</div>
                    </div>
                    <button onclick="removeParticipant('${participant.timestamp}')" 
                            style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">
                        ‚ùå
                    </button>
                `;
                container.appendChild(item);
            });
        }
        
        function removeParticipant(timestamp) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –æ—Ç–º–µ—Ç–∫—É?')) {
                eventData.participants = eventData.participants.filter(p => p.timestamp !== timestamp);
                saveData();
                renderParticipants();
            }
        }
        
        function exportToGoogleSheets() {
            if (eventData.participants.length === 0) {
                alert('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return;
            }
            
            if (!navigator.onLine) {
                alert('–¢—Ä–µ–±—É–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
                return;
            }
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
            const exportData = {
                kpNumber: eventData.kpNumber,
                participants: eventData.participants.filter(p => p.kp === eventData.kpNumber),
                exportTime: new Date().toISOString()
            };
            
            // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ Google Apps Script
            // –ü–æ–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∫ CSV
            let csv = '–ù–æ–º–µ—Ä —É—á–∞—Å—Ç–Ω–∏–∫–∞,–ö–ü,–î–∞—Ç–∞,–í—Ä–µ–º—è,Timestamp\n';
            exportData.participants.forEach(p => {
                csv += `"${p.number}","–ö–ü${p.kp}","${p.date}","${p.time}","${p.timestamp}"\n`;
            });
            
            downloadCSV(csv, `kp${eventData.kpNumber}_${new Date().toISOString().split('T')[0]}.csv`);
            
            // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
            eventData.lastExport = new Date().toISOString();
            saveData();
            
            showMessage('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
        }
        
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.click();
            
            URL.revokeObjectURL(url);
        }
        
        function clearAllData() {
            if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—Å–µ–º –ö–ü? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                if (confirm('–¢–æ—á–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å? –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!')) {
                    eventData.participants = [];
                    localStorage.removeItem('kp_tracking_data');
                    renderParticipants();
                    updateParticipantsCount();
                }
            }
        }
        
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.textContent = navigator.onLine ? 'üåê –û–Ω–ª–∞–π–Ω' : 'üîå –û—Ñ—Ñ–ª–∞–π–Ω';
            statusElement.style.color = navigator.onLine ? '#2ecc71' : '#e74c3c';
        }
        
        function updateCurrentTime() {
            document.getElementById('currentTime').textContent = 
                new Date().toLocaleTimeString('ru-RU');
        }
        
        function updateParticipantsCount() {
            const kpParticipants = eventData.participants.filter(p => p.kp === eventData.kpNumber);
            document.getElementById('participantsCount').textContent = 
                `–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ${kpParticipants.length}`;
        }
        
        function showMessage(message) {
            // –ú–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –∫—Ä–∞—Å–∏–≤—ã–π toast
            console.log(message);
        }
        
        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>